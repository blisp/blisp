module.exports = function many(parser, init, reduce) {
  return function(input, pos, cok, cerr, eok, eerr) {
    var ppos = pos,
      pacc = init,
      done = false

    function pcok(result, pos, input) {
      ppos = pos
      pacc = reduce(pacc, result, pos, input)
    }

    function perr() {
      done = true
    }

    function peok(result) {
      throw new Error(
        "Parser in many consumed no input: " + result + " at position: " + pos
      )
    }

    while (!done) {
      parser(input, ppos, pcok, perr, peok, perr)
    }

    return (ppos === pos ? eok : cok)(pacc, ppos, input)
  }
}
